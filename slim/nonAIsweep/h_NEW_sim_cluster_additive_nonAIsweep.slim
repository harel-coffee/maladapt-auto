// set up a simple neutral simulation 
initialize() { 
initializeMutationRate(1.8e-08*(2.31/3.31)*10); 
initializeTreeSeq(); 

// m1 mutation type: nonsyn 
// muts added at 2.31/3.31 the mutation rate, syn muts added w/msprime 
initializeMutationType("m1", 0.5, "g", -0.01026*10, 0.186); 

// m2 mutation type: adaptive 
defineConstant("adaptsel", runif(1,0.0001*10,0.01*10)); 
initializeMutationType("m2", 0.5, "s", "return adaptsel;"); //0.0125*10 
m2.convertToSubstitution == T; 

//genomic element: exon and uses a mixture of syn and nonsyn at a 1:2.31 ratio (Huber et al.) 
initializeGenomicElementType("g1", c(m1), c(1.0)); // no synonymous muts 

//read in exon and recomb info 
info_lines = readFile("/Users/xinjunzhang/Desktop/AI-ML_Project/adaptiveIntrogressionML-master/scripts_simulation_treeseq/extract_s/segments/sim_seq_info_chr3region.txt"); //EPAS1 

//recombination 
rec_ends = NULL; 
rec_rates = NULL; 
for (line in info_lines[substr(info_lines, 0, 2) == "rec"]) 
{ 
components = strsplit(line, " "); 
rec_ends = c(rec_ends, asInteger(components[1])); 
rec_rates = c(rec_rates, asFloat(components[2])); 
} 
//multiply rec rates by scaling factor 
initializeRecombinationRate(0.5*(1-(1-2*rec_rates)^10), rec_ends); 

//exons 
for (line in info_lines[substr(info_lines, 0, 2) == "exo"]) 
{ 
components = strsplit(line, " "); 
exon_starts = asInteger(components[1]); 
exon_ends = asInteger(components[2]); 
initializeGenomicElement(g1, exon_starts, exon_ends); 
} 

} 


1:8900 fitness(m1) { 
h = mut.mutationType.dominanceCoeff; 
if (homozygous) { 
return ((1.0 + 0.5*mut.selectionCoeff)*(1.0 + 0.5*mut.selectionCoeff)); 
} else { 
return (1.0 + mut.selectionCoeff * h); 
} 
} 


// burn-in for ancestral population 
1 early() { 
//setSeed(c(1071071165448,1871229033619,768903875248,512456706708,5254753194245,7899745971388,9835956050928,4362823803122,1354635626645,437277183314,1388356543099,5188158820494,20242353169,5828577304389,1905669978921,620254303587,7228066645842,1948013860577,2059699876802,3186177818960,6761114162582,2515498169498,7010554845273,8021765347747,2215334165832,4282793313647,628322742253,2999643171232,283773322510,2259629906943,1966990060273,6623707189000,2329745246543,9409191799246,6670961566839,9163603081066,7861820297572,1487285310620,2125375175852,4893779566165,6546534187321,6328471038616,4907390090418,2672184654591,1469904861929,195998624788,3230366749918,6759164252152,204155908354,7335323764704,8004999418457,3101488660475,7282274708156,7166037251137,7463801597762,9234775705761,5937092392490,1589238187735,2334386156628,4833481631581,4346501981169,881301373650,5726799875148,8366291526134,9161664621229,43453358746,1097568866963,3096778436601,3373742282193,936031256849,6268469344740,3890984806541,9075276548811,5948748735446,9084294511298,3145659133901,88404701317,2334344070402,1082981976051,8916905601467,653073013656,8483531590553,3467749806610,6814913975761,1014636839839,7397719681822,549433721199,4291538921781,6151382443148,196243689625,5550686046626,3362581716755,4369218418478,6938031924645,5533245615623,2247112888652,852638068367,2887494095767,2761953299424,9695935312216,1458175148794,4923470687869,7715177506507,1873420884886,1881854600315,7651641213989,1818692453958,9987473087440,3820524248300,4087590591095,2986715636427,2875904739841,3633799808065,3499665633294,385437448231,1323811448882,8930536973297,4112090347021,7168670330685,2322223693695,3215055690756,2369666354375,8560266659037,6936271816475,2933808132500,7938763542679,8089977240080,2757363087869,9899271073978,7148881846795,389569164377,508059326762,9969037047318,5971888181065,4003081214318,8230624656215,4939425091541,7960477388833,7990713159448,1313015625666,8070477166275,1515096725048,9988652036149,932103744196,1205994654119,2376834799628,6738100229513,6817413660241,5626140814993,8914914399725,3000807467253,747581704720,2249232692648,5854049157338,8847826597908,2835718422157,8185964867495,5346334111290,7341543185542,8315664917555,5140378364560,6463566802903,4020761017182,2772931452713,4683552679928,973294599653,3342398914305,3544701502516,5071326138873,7340810191713,6073544860961,7934456183043,4196508082058,3656102487653,9768875870923,4410838418517,1255969548455,6176932843145,276182672411,3839463734218,370137934716,1892767528196,7287218234662,3338310997906,4726334569920,1183578508182,2182038897119,268587985292,2875541814993,6202466959804,9561308459157,2279963029690,589947139583,5193928332355,279836404794,9947145994784,7120979182555,5297043032238,6565593120479,8043923552734,7202491639631,8589211165372,9194723372293,8319296234246,2973823042937,5963023941549,8764795342903,8441095267558,1790379130057,6449420203954,5928729191891,8634553401078,628373008821,1073716004911,6163899196315,5346453590047,1633843911118,9176239897036,1945341479487,4242425583285,4246111306095,6383702987630,9670383290168,1711942690494,2097599680968,3857411140698,2787457797747,3922974968531,191024688535,2727815893598,3772378027352,4925094197577,1001884327831,4217419721767,6411511203149,9270400197098,4288213336457,2001150017714,7309611931087,4300394062826,383636827565,796913451567,1773648697810,1661513646601,6019657264765,6270856346398,9582276802712,9373267864881,7565796280736,6177534089095,7940996132391,2011503872651,2900730127178,7569731699806,4592507519015,8773119387808,6433655495523,2350033917332,7902132740619,4640047744508,5748279947364,4831025912096,9742382703572,1199286702702,2538295041534,9856295665853,8028486865224,7245007134703,1228865683394,953477454593,8272908409875,4209041632850,7718991696016,37775424620,8115390304234,1104128946349,4796558036292,7615755073054,6251993940510,3764460326820,4652239101694,8574691907685,2676291750858,5753177139211,7453036148939,6087053776166,4121901375231,7621380468912,4779264326771,864521174281,2990542659266,2687402077710,9580693566475,9825373796595,4123585282848,2639875082602,2077125694237,4811892843859,5220983207993,3423124079933,389062289646,1410655499897,4172095709463,3354692822535,3478328051456,1460303784122,9135179972447,9045951323313,5075991889980,728842570760,1235609322217,2238209381757,2416882214421,2155849480282,1938786852905,3967141674885,2336472238831,3629753557201,7151252901005,4864146323547,6717208939007,4807271803316,8823649346179,2972405667792,7984002309081,4265429995584,5181148522662,7171584383310,2187567696754,9712803657814,7357591193684,2225147130029,7530174418391,9131984130201,6122983683486,8102425572019,3939195086371,8044193707638,8876245524544,1456678282516,7255403019375,3787523276937,1076670437336,3778351149288,4387008778,4869826202184,9854688606798,716335844036,8738958461088,677078560011,3565279048985,9459675808156,8270801593261,8902630523785,2696207374384,4271562596303,6366125175526,8359194013342,1416286585281,3814757141601,1205146329153,854030189746,9871294234509,236635537464,199409611612,3379653317326,8365016532082,1636420910366,1017405256180,9946121482621,8001608672225,5593318372705,3952022898492,3261020282250,1955089939160,9238673123638,7080042774011,7251481850733,2620719037069,2383651216438,4684008932361,5427369051958,5556677818993,8450913177641,6612155803543,1484987516367,7845296797058,4162869451069,8903532759691,2946756859951,7225641549248,4364702070749,7309123137613,8465021769961,5469219885327,3594882182139,702634537822,3535693002660,5936619450914,5136753633668,9315119338725,7663569661683,7182516937297,7989694381339,2314852502900,4744374519210,3880089970400,7656078966515,9574478769579,2109588321393,920737594216,1165827273743,8130324894199,3250920501751,8916103469479,5715703703030,1310663635059,1242713244871,6513986337443,1632468454304,8358541056593,4604647833815,5410628707074,7221640252038,3069545407598,8315237206687,2727878792922,9384985763532,2842766094153,1621743017852,3517883905065,5742487595566,391495457369,4900226452889,6046543022779,7165121137725,117657276150,1332342790135,9729756377440,6800461947097,4977764920213,2242615372569,5874658345701,5190608463807,1949980111995,3244563237051,5023374222116,403925835271,2607399412393,8339448997045,8406517152318,1348563624322,1591184962857,2883482164822,8249295355501,1897836128717,2240714867109,2155913971391,4884787284196,3178530602443,7535868007934,4254043095586,3841177285491,6078204208354,9111632351056,9089436652639,9057359398270,6007150377936,4828757069398,7795847489022,8150086211536,8043661036837,4409887757110,4786195465955,3801660588576,4616327050879,8333684239053,9715569626193,9863017965090,1654124038264,5313776308741,5634317023169,3612603884422,8894330815856,9785088110372,2158069862498,4747841996577,6381189831975,2184092644559,6746019950412,55862519215,4824480578582,7583294933541,4987407994096,3287312347062,3657513140998,9833059054332,7940631041267,5028623472620,1988030468436,6393632573935,1312609065559,8793823370327,6586256535366,4831933115924,9344622845535,2634342743987,9322574160977,791709426872,5344356705340,7821565409529,5380793223879,3430993896186,8110591916596,9816322508427,493095224989,5456833571186,3639102625982,3954317936766,6680633354742,932378553121,2007180705034,4069515053617,7647590320275,3323721028529,1885596944896,8284232216969,2413426025576,8365375718735,4246331426655,2043305834786,3356870315331,5219328033504,9028211207941,2597384165535,9386442531049,4597012764437,4661333631854,3115002575373,8940261549583,8766682133243,2597547616052,4260811229957,7973959556585,6264879579286,7197015673615,290592721944,9830164492765,2030097202466,6681097493570,7126239329873,8363490308925,9269000823911,5267121269090,8043158382077,6295686366364,6988080048704,167795355794,446426248157,4047516513659,1402370041933,8389063526559,5323907302306,4175610446392,3532452589670,1768248755549,2813633187290,2437819067687,6935254412303,9955463431129,1822670134381,4337912151904,618655264540,4385627208171,3227152260614,390756578878,9058361021288,5386536824754,6779353374458,2519479987089,9393602246573,1525938912877,1752236859743,9162787356489,8150834097018,891856053803,1374798841171,830224205687,2136936115708,3685845616889,7840001653244,5362492754619,1374029905238,7763265721077,4226659553622,7185625090672,567018387959,1850354866975,5228559794142,4935475882998,8477700232594,8266359792363,3686005798595,1170162232856,2447111433385,935933451188,226481691187,7895973958080,784405843516,16468610897,4902581042778,8153284163620,3714029092933,3962274062358,6540658453327,3907761228570,6017489181765,6587081584574,3221956452039,2091318196332,4249561807973,3946150805740,9118530560050,1950918494619,2324394995862,6310280331079,380247675462,6221297836843,3163281566729,1359975937902,7116042507239,9267098387097,344253951471,947796657258,3787892324596,4745773512762,5912156140196,2198293666251,2463750924776,4646057530042,966208318870,9302278723842,8657359729424,3937391923042,1263568953216,4011165843914,3533314808689,8549582530965,5425077963126,1936960035011,4028672324927,7228864327453,8867925951430,3921503209407,3491739592147,9719058546933,791140494771,6746051077430,1873388188174,8646929208039,5123701812976,2661644237476,9218431002589,3855284239712,4550753614690,8802280522415,1615010948938,5154996827855,878686608992,8644624773505,2367071933318,1406899633597,319168724678,4871411049295,4398641709092,9983170717189,9330138472212,9006074509671,8708961377068,135651648538,9817223014644,5279535738025,8841205887272,5894617169216,5569976509214,2517437846182,2913126189924,8950372130053,5222751037151,4606107999264,8533633541744,6043458392008,9177297624726,7040620357537,4319916827129,1076896282037,1708696420884,3938069871435,2805356058539,4451489922486,5347209775599,404373984705,9332897317870,8829628212452,5891709299483,3060416412725,4013919066009,9828309313285,663222466418,9312256471806,7747654533232,2510678782684,4346967334908,2660768285400,3163478915816,1046805959749,4816343202997,9993763958103,5136914818897,5837406380678,1049784253804,344636326577,3690988873809,1600750150492,3921030846764,1736006845479,7520892949864,4460316767393,5587415915977,9323906107783,6743935136385,8933289576114,5306037153793,6981086524432,3588456542239,7937906276551,5389461688166,8596537473490,815346563934,1699930217442,3371307463883,4752138410080,5175732450165,6518349835713,5130343094599,1165550446977,332891219953,9901277979581,3055274668688,8148344817000,9186357635091,8037850166244,611863065625,6802682701936,2687923038011,1818146022085,9399272067598,5277314366718,5035584649996,5923448098535,5306463445572,9830546394568,9285612540415,5494694351232,5767196668199,375103432185,5754595915659,4541438296785,6022414776763,391146043327,5582825187028,9469540353138,684185856073,5313738529862,8268293044619,4598659104884,4045920230536,2178542117062,6066382359559,30037988206,5717860682310,8791546571817,9368649289140,9058531350435,5321763462282,2962958734962,1474615107052,5176650972781,6861740969140,8804929569967,4646443185179,3600945813849,3459921163340,1455026982804,3885516333733,1731990240088,8676794767551,8361299862092,419048244294,1578124946290,4109497199574,2128954999740,9413624059921,9094768022426,1135925425697,4812348145369,7778416328503,6978988126682,4298582610744,3229558354101,7497435788570,4481078582514,4810295482344,7272717821380,8625827846737,9727305308035,5713399953990,9136915210054,2292924489944,4894274273926,3998085340519,4953750521841,8843921154036,774082767133,9153413553220,1382846613897,6872190985492,992305173878,6085133020019,6266897261928,8181084447366,4905098577156,8814118684759,3797414743841,9710340935989,5785332001787,8607865513137,8628680157854,5225944987341,3452462097257,8084643927274,4220087363866,1204354329112,8991978695154,1225886899665,2558880068229,1582361626103,8909146303131,2857256640501,3745324741828,4511443959518,1020167971723,1635071231102,942872435786,2077326401518,2575078827103,1502709819441,8696916167881,1636477204935,1136988688910,4317040081999,4658618384605,7850318080646,5304908207309,7432828483954,7163860520437,1889809453764,5346064524528,2509412546458,8836499493687,437710055802,1151990095499,8399991273501,5746235257321,3567493766405,3670987539251,2593417233887,5507818917263,7997056800277,7264354042308,1309159457580,3194131835416,9336280818277,9595856455809,2875962560300,9570196840299,9216066170511,8336603250630,9960698016299,8872288720797,6092242048766,5352142871468,332483201699,953361108689,3697165805623,7115541628707,7269801349238,5436652099193,6862264807038,6672856694559,5551359823825,2527614825116,8155327020573,1109166123246,2026729254908,7835826576357,9003464134785,1860333777089,6844930200867,2508377537280,5776631723729,5866614298837,9612933266035,1748970004150,6050480938822,4283732801553,9643138632356,5902059033001,7279327508746,6014751053842,9938177588072,8430974375400,4577337816606,3324400469240,2844374007591,9442730841031,8155964694830,817487872542,8586877680184,8521571294350,6966783389352,7499417865359,4891672370806,8396550097729,7138285311642,352506529301,9722169598392,2932019716268,9632843544619,258609749541,679153084585,4894219926305,6301064903763,2266899732928,7384436213770,9071927916856,2280798425522,8972888681679,1896781171015,9392877045514,2379871222827,4711461649931,4902816578664,9820565426132,8705320920982,500570453811,2567549609009,3154932227807,6500510135193,781015507256,3196541465100,1627442314765,8150248439123,846084858393,5716819597760,7762328543449,4113749314197,2048691113841,6999480784960,3040123207436,6602360034640,2167388697686,1088250399690,9183160853653,7260596768574,6219185668687,1970018908858,8617863890753,6758224892945,3576006676415,8646321185326,8459942206159,3763382509959,6673960480586,7905498610275,1916100251151,8093952079551,2315503259140,8306247444935,3215302808773,3752193189082,119231930817,8188456038227,5840160863530,5227394491632,6562343515313,3019476355766,327456428386,9422912426627,8845120288490)[0]); //define with -d simnum=$SGE_TASK_ID 
sim.addSubpop("p1", 730); 
defineConstant("simID",getSeed());defineConstant("newsel",getSeed()); 
sim.tag = simID; 

} 


// after burn-in, split off Neanderthals (p2) 
7300 early() { 
sim.addSubpopSplit("p2", 100, p1); 
} 



// set African population size 
8340 early() { 
p1.setSubpopulationSize(1447); 
} 

// split off Asian-Eur ancestor (p3) 
8696 early() { 
sim.addSubpopSplit("p3", 186, p1); 
p1.setMigrationRates(c(p2, p3), c(0, 0.00015)); 
p3.setMigrationRates(c(p1, p2), c(0.00015, 0)); 
} 

// Neanderthal hybridization 
8715 late() { 
sim.treeSeqRememberIndividuals(sim.subpopulations.individuals); 
sim.addSubpopSplit("p4", 186, p1); 
p4.setMigrationRates(c(p1,p2,p3), c(0.0, 0.001, 0.999)); 

target = sample(p4.genomes, 1); //fix it in source pop 
target.addNewDrawnMutation(m2, 2730973); //random mutation in the middle of the segment 
rm("simID",removeConstants=T); 
defineConstant("simID",getSeed()); 
sim.outputMutations(sim.mutationsOfType(m2)); 

p3.setSubpopulationSize(0);

sim.outputFull("/Users/xinjunzhang/Desktop/chr3region_"  +"allvar_"+ "temp_additive" + ".txt"); 

 
} 


8716: 8900 late() { 
muts = sim.mutationsOfType(m2); 
if (size(muts) !=1) 
{ 
cat("RESTART \n"); 
sim.readFromPopulationFile("/Users/xinjunzhang/Desktop/chr3region_"  +"allvar_"+ "temp_additive" + ".txt"); 
setSeed(getSeed() + 1); //sim.simulationFinished(); 
rm("simID",removeConstants=T); rm("newsel",removeConstants=T); 
defineConstant("simID",getSeed()); defineConstant("newsel",runif(1,0.0001*10,0.01*10)); 
} 

} 

//8716 late(){
//p4.setMigrationRates(c(p1,p2,p3), c(0.0, 0.0, 0.0)); 
//p3.setSubpopulationSize(0);
//}

8716 late() { 
mut = sim.mutationsOfType(m2); 
if (sim.tag!=simID){ 
mut.setSelectionCoeff(asFloat(newsel)); 
} 
else if (sim.tag==simID) 
{mut.setSelectionCoeff(asFloat(adaptsel));} 
sim.outputMutations(sim.mutationsOfType(m2)); 
} 



8741 late(){sim.outputMutations(sim.mutationsOfType(m2)); } 

//Neanderthal sample 
8748 late() { 
sim.outputMutations(sim.mutationsOfType(m2)); 
cat("tempfreq: "); 
print(sim.mutationFrequencies(p4, sim.mutationsOfType(m2))); 
sim.treeSeqRememberIndividuals(sample(p2.individuals, 2)); 
p2.setSubpopulationSize(0); 
} 


8740 late(){sim.outputMutations(sim.mutationsOfType(m2)); } 

// Asian founder bottleneck 
8808 early() { 
p4.setSubpopulationSize(55); 
p1.setMigrationRates(c(p4), c(7.8e-06)); 
p4.setMigrationRates(c(p1), c(7.8e-06)); 
} 

// Asian exponential growth 
8808:8900 { 
newSize = asInteger(round(1.048^(sim.generation - 8808) * 55)); 
p4.setSubpopulationSize(newSize); 
} 


8900 late() { 
sim.outputMutations(sim.mutationsOfType(m2)); 
cat("Frequencies: "); 
print(sim.mutationFrequencies(p4, sim.mutationsOfType(m2))); 
sim.treeSeqOutput("/Users/xinjunzhang/Desktop/chr3region_"  +"allvar_"+ "test_additive_sweep" + ".trees"); 
} 
